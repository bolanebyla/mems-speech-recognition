import numpy as np
from keras.models import model_from_json
from sound import wav2mfcc

sample_rate = 22050  # –ó–Ω–∞—á–µ–Ω–∏–µ sample_rate –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
feature_dim_1 = 20  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤–µ–ª–∏—á–∏–Ω–∞ MFCC –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
feature_dim_2 = int(.5 * sample_rate)  # —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ —Ñ—Ä–µ–π–º–æ–≤ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö 0.5 = 500 –º—Å)
step_mfcc = int(.1 * sample_rate)  # –®–∞–≥ —Å–º–µ—â–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ mfcc (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö 0.1 = 100–º—Å)
channel = 1  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤
n_classes = 3  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–æ–≤ –∫–æ–º–∞–Ω–¥

CLASSES = ['–ì–†–£–°–¢–¨', '–ú–ï–ú']  # –ö–ª–∞—Å—Å—ã –∫–æ–º–∞–Ω–¥ (–±–µ–∑ —Ñ–æ–Ω–∞)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
with open('model-mem.json', 'r') as f:
    model = model_from_json(f.read())

# –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏
model.load_weights("model-cnn.h5")


# –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
def predict(namefile, model, min_count=2, rate=0.9,
            hole=1):  # —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ –ø—É—Ç—å –∫ –Ω—É–∂–Ω–æ–º—É —Ñ–∞–π–ª—É, –∏ –∏–º—è –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    mfcc_full, audio_full = wav2mfcc(namefile, length=feature_dim_2,
                                     step=step_mfcc)  # –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ mfcc –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∏–º–µ–Ω–µ–º namefile

    # mfcc = xScaler.transform(mfcc_full.reshape(-1,1))
    mfcc_full = mfcc_full.reshape(-1, 20, 22, 1)
    g_pred = model.predict(mfcc_full)  # –ü—Ä–µ–¥–∏–∫—Ç–∏–º —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ model –º–∞—Å—Å–∏–≤ mfcc
    pred = np.array([np.argmax(i) for i in
                     g_pred])  # –í—ã–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–∞–∂–¥–æ–º g_pred[i]  –∏ —Å–æ–∑–¥–∞–µ–º numpy-–º–∞—Å—Å–∏–≤ pred –∏–∑ —ç—Ç–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
    out = []  # –û–±—ä—è–≤–ª—è–µ–º –≤—ã—Ö–æ–¥–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é out (–í –Ω–µ–π –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑ mfcc –∞—É–∏–¥–æ–¥–∞–Ω–Ω—ã–µ, –∫–ª–∞—Å—Å –∫–æ–º–∞–Ω–¥—ã –∏ —Ç–æ—á–Ω–æ—Å—Ç—å, —Å –∫–æ—Ç–æ—Ä–æ–π —Å–µ—Ç—å —Å—á–∏—Ç–∞–µ—Ç —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤–µ—Ä–Ω–æ–π)

    # –ò—â–µ–º –∫–æ–º–∞–Ω–¥—ã –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞
    for idx_class in range(n_classes - 1):
        idxs = np.where(
            pred == idx_class)  # –í –º–∞—Å—Å–∏–≤–µ pred –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º, —Ä–∞–≤–Ω—ã–º –∏—Å–∫–æ–º–æ–º—É –∫–ª–∞—Å—Å—É idx_class
        idxs = idxs[0]  # –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –º–∞–∞—Å–∏–≤–∞ –≤ np.where –∏–º–º–µ—Ç —Ç–∏–ø (x,). –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å
        if (len(idxs) == 0):  # –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –∏—Å–∫–æ–º–æ–≥–æ –∫–ª–∞—Å—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã,
            continue  # —Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–∏—Å–∫—É –∫–æ–º–∞–Ω–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞

        curr = []  # –í—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö
        '''
        –≤ –º–∞—Å—Å–∏–≤–µ idx –¥–∞–Ω–Ω—ã–µ –ø—Ä–¥–µ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
        [4, 5, 6, 7, 123, 124, 125, 126, 127]
        –≤ –º–∞—Å—Å–∏–≤ curr –º—ã –∑–∞–ø–∏—à–µ–º [4, 123] —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
        –ø–æ—Å–∫–æ–ª—å–∫—É –æ—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ 4,5,6,7 –∏ 123,124,125,126,127 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –µ–¥–∏–Ω—É—é –∫–æ–º–∞–Ω–¥—É
        '''
        curr_idx = int(idxs[0])  # –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
        summ, length = 0, 0  # summ - —Ö—Ä–∞–Ω–∏—Ç —Å—É–º–º—É –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π, —Å –∫–æ—Ç–æ—Ä–æ–π —Å–µ—Ç—å –æ—Ç–Ω–µ—Å–ª–∞ –∫–æ–º–∞–Ω–¥—É –∫ –¥–∞–Ω–Ω–æ–º—É –∫–ª–∞—Å—Å—É; length - –¥–ª–∏–Ω–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–¥—É—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã (–¥–ª—è –º–∞—Å—Å–∏–≤–∞ curr –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        # [4, 123] –¥–ª–∏–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –ø–µ—Ä–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É –±—É–¥–µ—Ç 4, –≤—Ç–æ—Ä–æ–º—É - 5 )
        for i in range(len(idxs)):  # –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º—É –º–∞—Å—Å–∏–≤—É idxs
            summ += g_pred[idxs[i]][idx_class]  # –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
            length += 1  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if i == len(idxs) - 1:  # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                if (
                        length >= min_count and summ / length >= rate):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—Å–ª–æ–≤–∏—è —Ä–∞–∑–±–æ—Ä–∞: –¥–ª–∏–Ω–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ min_count
                    # summ / length –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ rate
                    curr.append([curr_idx, length,
                                 summ / length])  # –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞–∞—Å–∏–≤ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã, –¥–ª–∏–Ω–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ summ / length
                break
            if idxs[i + 1] - idxs[
                i] > hole:  # –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞ 1 (–æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —É–∂–µ –∫ –¥—Ä—É–≥–æ–π –∫–æ–º–º–∞–Ω–¥–µ)
                if (
                        length >= min_count and summ / length >= rate):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—Å–ª–æ–≤–∏—è —Ä–∞–∑–±–æ—Ä–∞: –¥–ª–∏–Ω–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ min_count
                    # summ / length –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ rate
                    curr.append([curr_idx, length,
                                 summ / length])  # –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞–∞—Å–∏–≤ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã, –¥–ª–∏–Ω–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ summ / length
                curr_idx = int(idxs[i + 1])  # –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
                summ, length = 0, 0  # –û–±–Ω—É–ª—è–µ–º summ –∏ length
        curr_audio = []  # mfcc –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        for elem in curr:  # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º—É –º–∞—Å—Å–∏–≤—É curr
            # if (elem[0] != 0): # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–æ –≤–æ–∑—å–º–µ–º –Ω–∞ –æ–¥–Ω—É mfcc –ª–µ–≤–µ–µ (—á–∞—â–µ –≤—Å–µ–≥–æ —Ç–∞–º –±—É–¥–µ—Ç –ª–∏–±–æ —Ç–∏—à–∏–Ω–∞, –ª–∏–±–æ –Ω–∞—á–∞–ª–æ –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —Ä–∞–∑–æ–±—Ä–∞–ª–æ—Å—å —Å–µ—Ç—å—é)
            #  curr_audio = np.concatenate((audio_full[elem[0] - 1], audio_full[elem[0]][:, -step_mfcc:,:]), axis = 0)
            # else:
            curr_audio = audio_full[elem[0]]  # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–æ –±–µ—Ä–µ–º —Å–∞–º—É—é –ø–µ—Ä–≤—É—é mfcc
            for j in range(1, elem[
                1]):  # –ü—Ä–æ–±–µ–≥–∞–µ–º —Ü–∏–∫–ª –æ—Ç 1 –¥–æ elem[1]+1 (–≥–¥–µ elem[1] —Ö—Ä–∞–Ω–∏—Ç –¥–ª–∏–Ω–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –æ—Ç–Ω–µ—Å–µ–Ω–Ω—ã—Ö –∫ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ)
                if (elem[0] + j == len(audio_full)):  # –ï—Å–ª–∏ elem[0] + j —Ä–∞–≤–Ω–æ –¥–ª–∏–Ω–Ω–µ mfcc, —Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                    break
                # curr_audio = np.concatenate((curr_audio, audio_full[elem[0] + j][:,-step_mfcc:,:]), axis = 1) # –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω–∏–π mfcc, –∏—Å–ø–æ–ª—å–∑—É—é concatenate –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ —Ç–µ–∫—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é —Å—Ä–µ–∑ –¥–∏–Ω–Ω–æ–π step_mfcc –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                curr_audio = np.hstack((curr_audio, audio_full[elem[0] + j][-step_mfcc:]))
            curr_audio = np.array(curr_audio)  # –ü–µ—Ä–µ–≤–æ–¥–∏–º –º–∞—Å—Å–∏–≤ –≤ numpy
            # curr_mfcc = curr_mfcc.reshape (curr_mfcc.shape[0], curr_mfcc.shape[1]) # –£–±–∏—Ä–∞–µ–º —Ç—Ä–µ—Ç—å—é —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å
            # curr_mfcc_unscaled= xScaler.inverse_transform(curr_mfcc)
            # recon = librosa.feature.inverse.mfcc_to_audio(curr_mfcc_unscaled) # –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏ –∏–∑ mfcc
            out.append([curr_audio, idx_class, elem[2]])  # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –º–∞—Å—Å–∏–≤
    return out, pred, g_pred  # –í–æ–∑—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –¥–∞–Ω–Ω—ã–º–∏, –º–∞—Å—Å–∏–≤ —Å –∫–ª–∞—Å—Å–∞–º–∏ –∫–æ–º–∞–Ω–¥, –º–∞—Å—Å–∏–≤ —Å softmax –¥–∞–Ω–Ω—ã–º–∏

# –í—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞
def get_prediction_text(wavfiles, model=model, classes=CLASSES):
    result = ''
    class_name = None
    out, pred, _ = predict(wavfiles, model=model, min_count=3, rate=0.7,
                           hole=2)  # –í—ã–∑—ã–≤–∞–µ–º predict –¥–ª—è –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if (len(out) == 0):  # –ï—Å–ª–∏ –¥–ª–∏–Ω–Ω–∞ –º–∞—Å—Å–∏–≤–∞ —Ä–∞–≤–Ω–∞ 0, —Ç–æ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞
        result = '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ üòî'
    for elem in out:  # –ü—Ä–æ–±–µ–≥–∞–º –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –º–∞—Å—Å–∏–≤–∞ out
        result = '–†–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: "' + classes[elem[1]] + '" (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å - %.2f' % (
                elem[2] * 100) + ' %)'  # –í—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        class_name = classes[elem[1]]

    return result, class_name
